---
// SSR imports
import * as ErrorBoundary from "src/dynamic/ErrorBoundary";
import Layout from "./players/Layout.astro";
import "src/stylesheets/common.css";
import "src/stylesheets/markdown.css";
---

<script>
    // CSR imports
    import * as ErrorBoundary from "src/dynamic/ErrorBoundary";
    import * as PlayerRoute from "src/dynamic/PlayerRoute";

    const currentPathname = window.location.pathname;

    const playerMatch = currentPathname.match(/\/players\/([^\/]{1,64})\/?$/);

    type RouteType =
        | { id: "/players/$username"; username: string }
        | { id: "error"; message: string; stackTrace: string };

    const RouteDefinitions = {
        "/players/$username": PlayerRoute,
    } as const;

    if (playerMatch) {
        const [_, username] = playerMatch;
        onRouteChange({ id: "/players/$username", username: username });
    }

    function setHeader(config?: { title: string; backlink?: string }) {
        if (config) {
            document
                .getElementsByTagName("header")[0]
                .classList.remove("hidden");
            document.getElementById("title").innerHTML = config.title;
            const backlink = document.getElementById("backlink");
            backlink.setAttribute("href", config.backlink ?? "#");
            if (config.backlink) {
                backlink.classList.remove("hidden");
            } else {
                backlink.classList.add("hidden");
            }
        } else {
            document.getElementsByTagName("header")[0].classList.add("hidden");
        }
    }

    function onRouteChange(route: RouteType) {
        if (route.id == "error") {
            render(
                ErrorBoundary.Scaffolding(
                    route.message,
                    null,
                    route.stackTrace,
                ),
            );
            setHeader(null);
        }

        function onError(error) {
            onRouteChange({ ...error, id: "error" });
        }

        return (async () => {
            for (const [routeId, definition] of Object.entries(
                RouteDefinitions,
            )) {
                if (routeId === route.id) {
                    if (definition.HeaderConfig) {
                        const headerConfig =
                            await definition.HeaderConfig(route);
                        setHeader(headerConfig);
                        let documentTitle = "Deepworld 2025 MMO";
                        if (headerConfig?.title)
                            documentTitle =
                                headerConfig.title + " - " + documentTitle;
                        document.title = documentTitle;
                    }
                    render(
                        definition.Component(definition.placeholderLoader()),
                    );
                    const result = await definition.loader(route, { onError });
                    if (result) {
                        render(definition.Component(result));
                    }
                    return;
                }
            }
        })().catch((e) => {
            onRouteChange({
                id: "error",
                message: "Error occurred while fetching data.",
                stackTrace: e,
            });
            console.error(e);
        });
    }

    function render(component: string) {
        document.getElementById("app").innerHTML = component;
    }
</script>

<Layout>
    <div
        id="app"
        set:html={ErrorBoundary.Scaffolding(
            "Page not found!",
            "Please try refreshing the page and make sure to enable Javascript, or contact the developers on Discord.",
        )}
    />
</Layout>
